[ì œì•ˆìš”ì²­ ë¡œì§]
// API: POST /api/proposals/request

async function sendProposalRequest(requestData) {
  const { ì„ íƒë¸Œëœë“œ, ...proposalInfo } = requestData;
  
  // 1. í˜„ì¬ User ì •ë³´ ì¡°íšŒ
  const currentUser = await db.users.findUnique({
    where: { id: currentUserId }
  });
  
  // 2. ProposalRequest DBì— ì €ì¥
  const proposalRequest = await db.proposalRequests.create({
    ...proposalInfo,
    ì„ íƒë¸Œëœë“œ: ì„ íƒë¸Œëœë“œ,
    ìš”ì²­ì_id: currentUser.id,
    ë°œì†¡ìƒíƒœ: "ë°œì†¡ì¤‘"
  });
  
  // 3. ê° ë¸Œëœë“œì˜ ë§¤ë‹ˆì € ì •ë³´ ì¡°íšŒ
  const managers = await db.managers.findMany({
    where: {
      ë¸Œëœë“œ_id: { in: ì„ íƒë¸Œëœë“œ }
    },
    include: {
      brand: true
    }
  });
  
  // 4. ì´ë©”ì¼ í…œí”Œë¦¿ ìƒì„± ë° ë°œì†¡
  const emailsSent = [];
  
  for (const manager of managers) {
    const subject = `[íŒ¨ìŠ¤íŠ¸ë§¤ì¹˜] ê³µì‹¤ ë¬¸ì˜ì˜ ê±´ [${proposalInfo.ê³ ê°ì‚¬ëª…} : ${proposalInfo.í¬ë§ì§€í•˜ì² ì—­}ì—­ / ${proposalInfo.ì‹¤ì‚¬ìš©ì¸ì›}ì¸ì‹¤]`;
    
    // ì¸ì‹¤ í‘œì‹œ ë¡œì§
    let roomSizeText = "";
    if (proposalInfo.í¬ë§ì¸ì‹¤) {
      roomSizeText = `${proposalInfo.ì‹¤ì‚¬ìš©ì¸ì›} ~ ${proposalInfo.í¬ë§ì¸ì‹¤}ì¸ì‹¤ (ì‹¤ì‚¬ìš© ì¸ì›: ${proposalInfo.ì‹¤ì‚¬ìš©ì¸ì›}ëª…)`;
    } else {
      roomSizeText = `${proposalInfo.ì‹¤ì‚¬ìš©ì¸ì›}ì¸ì‹¤`;
    }
    
    // ì´ë©”ì¼ ë³¸ë¬¸ ìƒì„±
    const emailBody = generateEmailTemplate({
      manager: manager,
      proposal: proposalInfo,
      roomSizeText: roomSizeText,
      requester: currentUser
    });
    
    // ì´ë©”ì¼ ë°œì†¡
    try {
      await sendEmail({
        to: manager.ì´ë©”ì¼,
        cc: [
          manager.ì°¸ì¡°ë©”ì¼, 
          currentUser.ì´ë©”ì¼,        // âœ… Userì˜ ì´ë©”ì¼ë¡œ íšŒì‹  ë°›ìŒ
          "official@fastmatch.kr"
        ].filter(Boolean),
        replyTo: currentUser.ì´ë©”ì¼,  // âœ… ë‹µì¥ì€ Userì˜ ì´ë©”ì¼ë¡œ
        subject: subject,
        html: emailBody
      });
      
      emailsSent.push(manager.ë¸Œëœë“œ_id);
    } catch (error) {
      console.error(`Email send failed for ${manager.ì´ë©”ì¼}:`, error);
    }
  }
  
  // 5. ë°œì†¡ ìƒíƒœ ì—…ë°ì´íŠ¸
  await db.proposalRequests.update({
    where: { id: proposalRequest.id },
    data: {
      ë°œì†¡ìƒíƒœ: emailsSent.length > 0 ? "ë°œì†¡ì™„ë£Œ" : "ë°œì†¡ì‹¤íŒ¨",
      ë°œì†¡ì¼ì‹œ: new Date()
    }
  });
  
  return {
    success: true,
    emails_sent: emailsSent.length,
    total_managers: managers.length
  };
}
```

---

## ì´ë©”ì¼ êµ¬ì¡° (ìˆ˜ì •)
```
From: noreply@fastmatch.kr
To: fastfive.manager@example.com (ë¸Œëœë“œ ë§¤ë‹ˆì €)
Cc: fastfive.cc@example.com (ë§¤ë‹ˆì € ì°¸ì¡°ë©”ì¼)
    hong@smatch.kr (ìš”ì²­í•œ User ì´ë©”ì¼) âœ…
    official@fastmatch.kr (ê³ ì • ì°¸ì¡°)
Reply-To: hong@smatch.kr (ìš”ì²­í•œ User ì´ë©”ì¼) âœ…

Subject: [íŒ¨ìŠ¤íŠ¸ë§¤ì¹˜] ê³µì‹¤ ë¬¸ì˜ì˜ ê±´ [(ì£¼)í…Œí¬ìŠ¤íƒ€íŠ¸ì—… : ê°•ë‚¨ì—­ / 10ì¸ì‹¤]

Body:
ì•ˆë…•í•˜ì‹­ë‹ˆê¹Œ, íŒ¨ìŠ¤íŠ¸íŒŒì´ë¸Œ í™ê¸¸ë™ ë§¤ë‹ˆì €ë‹˜.
íŒ¨ìŠ¤íŠ¸ë§¤ì¹˜ í™ê¸¸ë™ì…ë‹ˆë‹¤.

ì‹ ê·œ ê³ ê°ì‚¬ê°€ ìˆì–´ ë¬¸ì˜ë“œë¦½ë‹ˆë‹¤.

[ê³ ê°ì‚¬ ì •ë³´ í…Œì´ë¸”]

ì œì•ˆ ê°€ëŠ¥í•œ ê³µì‹¤ ìˆìœ¼ë©´ í”¼ë“œë°± ë¶€íƒë“œë¦½ë‹ˆë‹¤.
ê°ì‚¬í•©ë‹ˆë‹¤.
íŒ¨ìŠ¤íŠ¸ë§¤ì¹˜ í™ê¸¸ë™ ë“œë¦¼.

--
[ì„œëª…]
```

**ì¤‘ìš”:**
- `Reply-To: hong@smatch.kr` ì„¤ì •ìœ¼ë¡œ ë¸Œëœë“œ ë§¤ë‹ˆì €ê°€ "ë‹µì¥" ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ìë™ìœ¼ë¡œ Userì˜ ì´ë©”ì¼ë¡œ ë‹µì¥ë¨
- `Cc`ì— User ì´ë©”ì¼ í¬í•¨ìœ¼ë¡œ Userë„ ë°œì†¡ëœ ì´ë©”ì¼ ë‚´ìš© í™•ì¸ ê°€ëŠ¥
- ê³ ê°ì‚¬ ë‹´ë‹¹ì ì´ë©”ì¼(`kim@techstartup.com`)ì€ DBì—ë§Œ ì €ì¥ë˜ê³  ì´ë©”ì¼ ë°œì†¡ì—ëŠ” ì‚¬ìš©ë˜ì§€ ì•ŠìŒ

---

## ì œì•ˆ ìš”ì²­ ì„±ê³µ ë©”ì‹œì§€ ìˆ˜ì •
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                               â”‚
â”‚              âœ“ ì œì•ˆ ìš”ì²­ì´ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤                      â”‚
â”‚                                                               â”‚
â”‚  ë°œì†¡ ì™„ë£Œ: 3ê°œ ë¸Œëœë“œ (íŒ¨ìŠ¤íŠ¸íŒŒì´ë¸Œ, ìŠ¤íŒŒí¬í”ŒëŸ¬ìŠ¤, ìœ„ì›Œí¬)     â”‚
â”‚                                                               â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â”‚
â”‚                                                               â”‚
â”‚  ğŸ“§ ë¸Œëœë“œ ë‹µë³€ì€ ë‚´ ì´ë©”ì¼ë¡œ ì§ì ‘ ì „ë‹¬ë©ë‹ˆë‹¤                  â”‚
â”‚     (hong@smatch.kr)                                         â”‚
â”‚                                                               â”‚
â”‚  ğŸ“‹ ë°œì†¡ëœ ì´ë©”ì¼ì€ ì°¸ì¡°ë¡œ ë°›ìœ¼ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤                  â”‚
â”‚                                                               â”‚
â”‚  ğŸ“‹ ìš”ì²­ ë‚´ì—­ì€ [ì œì•ˆ ìš”ì²­ ê´€ë¦¬]ì—ì„œ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤      â”‚
â”‚                                                               â”‚
â”‚                                                               â”‚
â”‚                              [ì œì•ˆ ìš”ì²­ ê´€ë¦¬]  [ë©”ì¸ìœ¼ë¡œ]      â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


[ì¶”ê°€ì œì•ˆìš”ì²­ë¡œì§]

// API: POST /api/proposals/requests/{proposal_id}/add

async function addProposalRequest(proposalId, additionalBrands) {
  // 1. ê¸°ì¡´ ì œì•ˆ ìš”ì²­ ì •ë³´ ì¡°íšŒ
  const originalProposal = await db.proposalRequests.findUnique({
    where: { id: proposalId },
    include: {
      ë°œì†¡ë‚´ì—­: true
    }
  });
  
  // 2. ê¸°ì¡´ ë°œì†¡ ë¸Œëœë“œ ì¶”ì¶œ
  const existingBrandIds = originalProposal.ì„ íƒë¸Œëœë“œ;
  
  // 3. ì¤‘ë³µ ì²´í¬: ì¶”ê°€í•˜ë ¤ëŠ” ë¸Œëœë“œê°€ ì´ë¯¸ ë°œì†¡ëœ ë¸Œëœë“œì— í¬í•¨ë˜ì–´ ìˆëŠ”ì§€
  const duplicateBrands = additionalBrands.filter(
    brandId => existingBrandIds.includes(brandId)
  );
  
  if (duplicateBrands.length > 0) {
    throw new Error("ì´ë¯¸ ë°œì†¡í•œ ë¸Œëœë“œê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤");
  }
  
  // 4. ì¶”ê°€ ë¸Œëœë“œì˜ ë§¤ë‹ˆì € ì •ë³´ ì¡°íšŒ
  const newManagers = await db.managers.findMany({
    where: {
      ë¸Œëœë“œ_id: { in: additionalBrands }
    },
    include: {
      brand: true
    }
  });
  
  // 5. ì´ë©”ì¼ ë°œì†¡
  const currentUser = await db.users.findUnique({
    where: { id: originalProposal.ìš”ì²­ì_id }
  });
  
  const emailsSent = [];
  
  for (const manager of newManagers) {
    const subject = `[íŒ¨ìŠ¤íŠ¸ë§¤ì¹˜] ê³µì‹¤ ë¬¸ì˜ì˜ ê±´ [${originalProposal.ê³ ê°ì‚¬ëª…} : ${originalProposal.í¬ë§ì§€í•˜ì² ì—­}ì—­ / ${originalProposal.ì‹¤ì‚¬ìš©ì¸ì›}ì¸ì‹¤]`;
    
    let roomSizeText = originalProposal.í¬ë§ì¸ì‹¤
      ? `${originalProposal.ì‹¤ì‚¬ìš©ì¸ì›} ~ ${originalProposal.í¬ë§ì¸ì‹¤}ì¸ì‹¤ (ì‹¤ì‚¬ìš© ì¸ì›: ${originalProposal.ì‹¤ì‚¬ìš©ì¸ì›}ëª…)`
      : `${originalProposal.ì‹¤ì‚¬ìš©ì¸ì›}ì¸ì‹¤`;
    
    const emailBody = generateEmailTemplate({
      manager: manager,
      proposal: originalProposal,
      roomSizeText: roomSizeText,
      requester: currentUser
    });
    
    try {
      await sendEmail({
        to: manager.ì´ë©”ì¼,
        cc: [manager.ì°¸ì¡°ë©”ì¼, currentUser.ì´ë©”ì¼, "official@fastmatch.kr"].filter(Boolean),
        replyTo: currentUser.ì´ë©”ì¼,
        subject: subject,
        html: emailBody
      });
      
      emailsSent.push(manager.ë¸Œëœë“œ_id);
    } catch (error) {
      console.error(`Email send failed for ${manager.ì´ë©”ì¼}:`, error);
    }
  }
  
  // 6. DB ì—…ë°ì´íŠ¸: ë¸Œëœë“œ ëª©ë¡ì— ì¶”ê°€
  await db.proposalRequests.update({
    where: { id: proposalId },
    data: {
      ì„ íƒë¸Œëœë“œ: [...existingBrandIds, ...emailsSent],
      ìˆ˜ì •ì¼ì‹œ: new Date()
    }
  });
  
  // 7. ë°œì†¡ ë‚´ì—­ ê¸°ë¡
  await db.proposalSendHistory.createMany({
    data: emailsSent.map(brandId => ({
      proposal_request_id: proposalId,
      ë¸Œëœë“œ_id: brandId,
      ë°œì†¡ìœ í˜•: "ì¶”ê°€ë°œì†¡",
      ë°œì†¡ì¼ì‹œ: new Date()
    }))
  });
  
  return {
    success: true,
    emails_sent: emailsSent.length,
    total_brands: originalProposal.ì„ íƒë¸Œëœë“œ.length + emailsSent.length
  };
}

[ë³€ê²½ì œì•ˆìš”ì²­ ë¡œì§]
// API: POST /api/proposals/requests/{proposal_id}/modify

async function modifyProposalRequest(proposalId, updatedData) {
  // 1. ê¸°ì¡´ ì œì•ˆ ìš”ì²­ ì •ë³´ ì¡°íšŒ
  const originalProposal = await db.proposalRequests.findUnique({
    where: { id: proposalId }
  });
  
  // 2. ê¸°ì¡´ ë°œì†¡í–ˆë˜ ë¸Œëœë“œì˜ ë§¤ë‹ˆì € ì •ë³´ ì¡°íšŒ
  const managers = await db.managers.findMany({
    where: {
      ë¸Œëœë“œ_id: { in: originalProposal.ì„ íƒë¸Œëœë“œ }
    },
    include: {
      brand: true
    }
  });
  
  // 3. í˜„ì¬ User ì •ë³´ ì¡°íšŒ
  const currentUser = await db.users.findUnique({
    where: { id: originalProposal.ìš”ì²­ì_id }
  });
  
  // 4. ë³€ê²½ëœ ë‚´ìš©ìœ¼ë¡œ ì´ë©”ì¼ ë°œì†¡
  const emailsSent = [];
  
  for (const manager of managers) {
    // âœ… ì œëª©ì— [ë³€ê²½] í‘œì‹œ
    const subject = `[íŒ¨ìŠ¤íŠ¸ë§¤ì¹˜] [ë³€ê²½] ê³µì‹¤ ë¬¸ì˜ì˜ ê±´ [${updatedData.ê³ ê°ì‚¬ëª…} : ${updatedData.í¬ë§ì§€í•˜ì² ì—­}ì—­ / ${updatedData.ì‹¤ì‚¬ìš©ì¸ì›}ì¸ì‹¤]`;
    
    let roomSizeText = updatedData.í¬ë§ì¸ì‹¤
      ? `${updatedData.ì‹¤ì‚¬ìš©ì¸ì›} ~ ${updatedData.í¬ë§ì¸ì‹¤}ì¸ì‹¤ (ì‹¤ì‚¬ìš© ì¸ì›: ${updatedData.ì‹¤ì‚¬ìš©ì¸ì›}ëª…)`
      : `${updatedData.ì‹¤ì‚¬ìš©ì¸ì›}ì¸ì‹¤`;
    
    // âœ… ì´ë©”ì¼ ë³¸ë¬¸ì— ë³€ê²½ ì•ˆë‚´ ì¶”ê°€
    const changeNotice = `
      <p style="color: #d32f2f; font-weight: bold;">
      âš ï¸ ì´ì „ì— ë¬¸ì˜ë“œë¦° ì¡°ê±´ì´ ë³€ê²½ë˜ì–´ ì¬ë°œì†¡ë“œë¦½ë‹ˆë‹¤.
      </p>
    `;
    
    const emailBody = changeNotice + generateEmailTemplate({
      manager: manager,
      proposal: updatedData,
      roomSizeText: roomSizeText,
      requester: currentUser
    });
    
    try {
      await sendEmail({
        to: manager.ì´ë©”ì¼,
        cc: [manager.ì°¸ì¡°ë©”ì¼, currentUser.ì´ë©”ì¼, "official@fastmatch.kr"].filter(Boolean),
        replyTo: currentUser.ì´ë©”ì¼,
        subject: subject,
        html: emailBody
      });
      
      emailsSent.push(manager.ë¸Œëœë“œ_id);
    } catch (error) {
      console.error(`Email send failed for ${manager.ì´ë©”ì¼}:`, error);
    }
  }
  
  // 5. DB ì—…ë°ì´íŠ¸: ì œì•ˆ ìš”ì²­ ì •ë³´ ê°±ì‹ 
  await db.proposalRequests.update({
    where: { id: proposalId },
    data: {
      ...updatedData,
      ìˆ˜ì •ì¼ì‹œ: new Date()
    }
  });
  
  // 6. ë°œì†¡ ë‚´ì—­ ê¸°ë¡
  await db.proposalSendHistory.createMany({
    data: emailsSent.map(brandId => ({
      proposal_request_id: proposalId,
      ë¸Œëœë“œ_id: brandId,
      ë°œì†¡ìœ í˜•: "ë³€ê²½ë°œì†¡",
      ë°œì†¡ì¼ì‹œ: new Date()
    }))
  });
  
  return {
    success: true,
    emails_sent: emailsSent.length,
    brands_updated: emailsSent.length
  };
}
```

---

## DB êµ¬ì¡° ì¶”ê°€: ProposalSendHistory
```
[ProposalSendHistory] (ë°œì†¡ ë‚´ì—­ ì¶”ì )
â””[id] : PK, UUID
â””[proposal_request_id] : FK â†’ ProposalRequest.id, required
â””[ë¸Œëœë“œ_id] : FK â†’ Brand.id, required
â””[ë°œì†¡ìœ í˜•] : enum, required / "ìµœì´ˆë°œì†¡", "ì¶”ê°€ë°œì†¡", "ë³€ê²½ë°œì†¡"
â””[ë°œì†¡ì¼ì‹œ] : timestamp, required
â””[ë°œì†¡ì„±ê³µì—¬ë¶€] : boolean, default=true

[ë¸Œëœë“œ ì„ íƒ ë“œë¡­ë‹¤ìš´]
// API: GET /api/brands/available-for-addition?proposal_id={proposal_id}

async function getAvailableBrandsForAddition(proposalId) {
  // 1. ê¸°ì¡´ ì œì•ˆ ìš”ì²­ ì •ë³´ ì¡°íšŒ
  const proposal = await db.proposalRequests.findUnique({
    where: { id: proposalId }
  });
  
  // 2. ì „ì²´ í™œì„± ë¸Œëœë“œ ì¡°íšŒ
  const allBrands = await db.brands.findMany({
    where: { ìƒíƒœ: "í™œì„±" }
  });
  
  // 3. ì´ë¯¸ ë°œì†¡í•œ ë¸Œëœë“œ ì œì™¸
  const availableBrands = allBrands.filter(
    brand => !proposal.ì„ íƒë¸Œëœë“œ.includes(brand.id)
  );
  
  return availableBrands;
}